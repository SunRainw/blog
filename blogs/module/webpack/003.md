---
title: 加载和处理其他资源
date: 2021-07-20
tags:
  - webpack
categories:
  - 前端工程化
sidebar: auto
---

## 其他资源处理
### 案例

常见的使用图片的方式有两种：

1. img 元素，设置**src 属性**
2. 其他元素（例如 div），设置**background-image 的 css 属性**

我们在页面中分别添加 img 和 div 背景

```javaScript
// component.js
import zznhImage from "../img/zznh.png"

...

// 创建一个img元素，设置src属性
const imgEl = new Image()
// imgEl.src = require("../img/zznh.png").default; // file-loader 5.x以后返回的是一个对象，我们需要使用它的default属性
imgEl.src = zznhImage
element.appendChild(imgEl)

// 创建一个div，设置背景图片
const bgDivEl = document.createElement("div")
bgDivEl.style.width = 200 + 'px'
bgDivEl.style.height = 200 + 'px'
bgDivEl.className = "bg-image"
bgDivEl.style.backgroundColor = "red"
element.appendChild(bgDivEl)

```

```css
.bg-image {
  display: inline-block;
  background-image: url("../img/nhlt.jpg") contain;
}
```

这个时候就会发现，`yarn build`打包会报错，因为没有解析图片文件的 loader

### file-loader

要处理 jpg、png 等格式的图片，我们也需要有对应的 loader：`file-loader`

`file-loader`的作用就是帮助我们处理**import/require()**方式引入的文件资源，并且会将它放到我们输出的文件夹中

#### 安装 file-loader

```bash
yarn add file-loader --dev
# or npm install file-loader -D
```

#### 配置处理图片的 rule

```javaScript
rules: [
  {
    test: /\.(png|jpe?g|gif|svg)$/i, // 此时使用jpe?g可以代替jpeg|jpg
    use: {
      loader: "file-loader"
    }
  }
]
```

> 注意：file-loader 5.x 以后**require()**返回的是一个对象，我们需要使用它的 default 属性才能获取资源(之前是直接获取资源)，也可以使用 import 来获取文件

### 文件的名称规则

有时候我们处理的**文件名称**按照一定的规则进行显示，例如：保留原来的**文件名**、**扩展名**，同时为了防止重复，包含一个**hash 值**等

这个时候我们可以使用`placeholder`来完成，webpack 给我们提供了大量的 placeholders 来显示不同的内容，可以在[webpack 的文档](https://v4.webpack.js.org/loaders/file-loader/#placeholders)中查阅（现在的 webpack5 的文档中已经没有 file-loader 了）

常用的 placeholder：

- [ext]：处理文件的扩展名
- [name]：处理文件的名称
- [hash]：文件的内容，使用 MD4 的散列函数(hash 函数)处理，生成一个 128 位的 hash 值(32 个十六进制)
- [contentHash]：在 file-loader 中和[hash]结果是一致的(在 webpack 的一些其他地方不一样)
- [hash: \<length\>]：截取 hash 的长度，默认 32 个字符太长了
- [path]：文件相对于 webpack 配置文件的路径

#### 实际操作

```javaScript
{
  test: /\.(jpe?g|png|svg)$/,
  use: [
    {
      loader: "file-loader",
      options: {
        name: "img/[name].[hash:6].[ext]", // 指定输出的文件名
        // outputPath: "img" // 一般不用，一般直接写在上面的name中
      }
    }
  ]
}
```

我们设置名称的时候也可以直接在 name 中指定输出的文件夹，这也是 vue 的写法，也可以在`outputPath`中指定输出文件夹

### url-loader

`url-loader`和`file-loader`的工作方式是相似的，但是可以将较小的文件，转成**base64 的 URL**

#### 安装 url-loader

```bash
yarn add url-loader --dev
# or npm install url-loader -D
```

#### 使用

```javaScript
{
  test: /\.(jpe?g|png|svg)$/,
  use: [
    {
      loader: "url-loader",
      options: {
        name: "img/[name].[hash:6].[ext]", // 指定输出的文件名
      }
    }
  ]
}
```

显示结果和之前一样，并且图片可以正常显示，但是`dist`文件夹中，我们会看不到图片文件：`url-loader`默认情况下会将所有的图片转成 base64 编码

#### url-loader 的 limit

但是开发中我们往往是**小的图片需要转换**，但是**大的图片直接使用图片**即可

- 因为**小的图片转换 base64**之后可以和页面一起被请求，减少不必要的请求过程
- 而大的图片也进行转换，反而会**影响页面的请求速度**

我们可以利用`url-loader`的**limit**属性，限制哪些大小的图片转换和不转换

```javaScript
{
  test: /\.(jpe?g|png|svg)$/,
  use: [
    {
      loader: "url-loader",
      options: {
        name: "img/[name].[hash:6].[ext]", // 指定输出的文件名
        limit: 100 * 1024
      }
    }
  ]
}
```

这样大于 100k 的图片就不会转换和小于 100k 的图片就会转换

## webpack5的处理方式
### Asset module type

#### 介绍

我们当前使用的 webpack 版本是 webpack5：

- 在 webpack5 之前，加载这些资源我们需要使用一些 loader，例如`raw-loader`、`url-loader`、`file-loader`
- 在 webpack5 之后，我们可以直接使用**资源模块类型(asset module type)**，来替代上面的这些 loader

**资源模块类型(asset module type)**，通过添加 4 种新的模块类型，来替换所有这些 loader

- asset/resource：发送一个单独的文件并导出 URL。（类似之前通过`file-loader`实现）
- asset/inline：导出一个资源的 dataURL。（类似之前通过`url-loader`实现）
- asset/source：导出资源的源代码。（类似之前通过`row-loader`实现）
- asset：在导出一个 data URL 和发送一个单独的文件之间自动选择。（类似之前通过使用`url-loader`，并配置资源体积限制实现）

#### 使用

加载图片可以使用下面的方式

```javaScript
rules: [
  {
    test: /\.(jpe?g|png|svg)$/,
    type: "asset/resource",
  }
]
```

我们也可以通过以下两种方式自定义文件的输出路径和文件名

- 方式 1：修改 output，添加 assetModuleFilename 属性

```javaScript
output: {
  filename: "js/bundle.js",
  path: path.resolve(__dirname, "./dist"),
  assetModuleFilename: "img/[name].[hash:6][ext]"
}
```

- 方式 2： 在 Rule 中，添加一个 generator 属性，并且设置 filename

```javaScript
rules: [
  {
    test: /\.(jpe?g|png|svg)$/,
    type: "asset/resource",
    generator: {
      filename: "img/[name].[hash:6][ext]"
    },
  }
]
```

如果想实现 url-loader 的 limit 效果，则需要两个步骤

- 步骤 1：将 type 修改为 asset
- 步骤 2：添加一个 parser 属性，并且制定 dataUrl 的条件，添加 maxSize 属性

```javaScript
rules: [
  {
    test: /\.(jpe?g|png|svg)$/,
    type: "asset",
    generator: {
      filename: "img/[name].[hash:6][ext]"
    },
    parser: {
      dataUrlCondition: {
        maxSize: 100 * 1024
      }
    }
  }
]
```
